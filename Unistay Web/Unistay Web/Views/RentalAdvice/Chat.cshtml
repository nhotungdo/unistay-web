@{
    ViewData["Title"] = "Chat Chuyên Gia AI";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex align-items-center mb-4">
                <div class="bg-primary text-white rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                </div>
                <div>
                    <h2 class="fw-bold m-0">Trợ Lý Ảo Unistay</h2>
                    <p class="text-muted m-0 small">Luôn sẵn sàng hỗ trợ bạn 24/7</p>
                </div>
            </div>

            <div class="glass-card chat-container d-flex flex-column" style="height: 600px;">
                <!-- Chat Messages Area -->
                <div id="chatMessages" class="flex-grow-1 p-4 overflow-auto border-bottom">
                    <div class="message ai-message mb-3">
                        <div class="content p-3 rounded-3 bg-light d-inline-block" style="max-width: 80%;">
                            Xin chào! Tôi là trợ lý AI của Unistay. Tôi có thể giúp gì cho bạn về việc tìm trọ, phân tích giá cả hoặc tư vấn khu vực an toàn?
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-3">
                    <form id="chatForm" class="d-flex gap-2">
                        <input type="text" id="userMessage" class="form-control form-control-lg border-0 bg-light" placeholder="Nhập câu hỏi của bạn..." required>
                        <button type="submit" class="btn btn-primary btn-lg rounded-circle p-0 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const chatMessages = document.getElementById('chatMessages');

            function appendMessage(text, isUser) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${isUser ? 'user-message text-end' : 'ai-message'} mb-3`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = `content p-3 rounded-3 d-inline-block ${isUser ? 'bg-primary text-white' : 'bg-light'}`;
                contentDiv.style.maxWidth = '80%';
                contentDiv.style.textAlign = 'left';
                contentDiv.textContent = text;
                
                msgDiv.appendChild(contentDiv);
                chatMessages.appendChild(msgDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            $('#chatForm').on('submit', function(e) {
                e.preventDefault();
                const input = $('#userMessage');
                const message = input.val().trim();
                if (!message) return;

                // Append user message
                appendMessage(message, true);
                input.val('');

                // Loading state
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message ai-message mb-3';
                loadingDiv.innerHTML = '<div class="content p-3 rounded-3 bg-light d-inline-block"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang trả lời...</div>';
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Send to API
                $.ajax({
                    url: '@Url.Action("GetChatResponse", "RentalAdvice")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ message: message }),
                    success: function(res) {
                        chatMessages.removeChild(loadingDiv);
                        appendMessage(res.response, false);
                    },
                    error: function() {
                        chatMessages.removeChild(loadingDiv);
                        appendMessage("Xin lỗi, tôi đang gặp sự cố kết nối. Vui lòng thử lại sau.", false);
                    }
                });
            });
        });
    </script>
}
