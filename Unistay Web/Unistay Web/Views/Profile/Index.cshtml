@model Unistay_Web.Models.User.UserProfile
@{
    ViewData["Title"] = "Hồ sơ của tôi";
}

<!-- Styles -->
<style>
    :root {
        --primary-color: #6366f1;
        --secondary-color: #a855f7;
        --bg-light: #f8fafc;
        --text-dark: #1e293b;
        --card-radius: 16px;
        --transition: all 0.3s ease;
    }

    body {
        background-color: #f1f5f9;
        font-family: 'Inter', sans-serif;
    }

    /* Cover & Header */
    .profile-cover-section {
        position: relative;
        margin-bottom: 5rem;
    }

    .profile-cover {
        height: 280px;
        background: linear-gradient(45deg, #1e1b4b, #4f46e5);
        background-size: cover;
        background-position: center;
        border-radius: 0 0 24px 24px;
        position: relative;
        overflow: hidden;
    }

    .cover-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
    }

    .profile-header-card {
        position: absolute;
        bottom: -60px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 1000px;
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        z-index: 10;
    }

    .avatar-box {
        position: relative;
        width: 120px;
        height: 120px;
        flex-shrink: 0;
    }

    .avatar-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 4px solid white;
        object-fit: cover;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .avatar-badge {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 32px;
        height: 32px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        cursor: pointer;
    }

    /* ESCAPED @@media here */
    @@media (max-width: 768px) {
        .profile-header-card {
            flex-direction: column;
            text-align: center;
            bottom: -180px;
            padding: 2rem 1rem;
        }
        .profile-cover-section {
            margin-bottom: 12rem;
        }
    }

    /* Actions Grid */
    .quick-actions-card {
        background: white;
        border-radius: var(--card-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        border-radius: 12px;
        background: #f8fafc;
        color: var(--text-dark);
        text-decoration: none;
        transition: var(--transition);
        border: 1px solid transparent;
        height: 100%;
    }

    .action-btn:hover {
        background: #e0e7ff;
        color: var(--primary-color);
        border-color: #c7d2fe;
        transform: translateY(-2px);
    }

    .action-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--primary-color);
    }

    /* Content Tabs */
    .nav-pills-custom .nav-link {
        color: var(--text-dark);
        background: white;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        padding: 1rem;
        font-weight: 600;
        text-align: left;
        border: 1px solid transparent;
        transition: var(--transition);
    }

    .nav-pills-custom .nav-link i {
        margin-right: 0.75rem;
        font-size: 1.1rem;
        color: #94a3b8;
    }

    .nav-pills-custom .nav-link.active {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .nav-pills-custom .nav-link.active i {
        color: white;
    }

    .nav-pills-custom .nav-link:hover:not(.active) {
        background: #f1f5f9;
        color: var(--primary-color);
    }

    /* Info Cards */
    .content-card {
        background: white;
        border-radius: var(--card-radius);
        padding: 2rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        height: 100%;
    }

    .section-title {
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .info-row {
        display: flex;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px dashed #f1f5f9;
    }

    .info-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .info-label {
        width: 35%;
        color: #64748b;
        font-weight: 500;
    }

    .info-value {
        width: 65%;
        color: var(--text-dark);
        font-weight: 600;
    }

    .zodiac-card {
        background: linear-gradient(135deg, #1e1b4b 0%, #4338ca 100%);
        color: white;
        border-radius: 16px;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .zodiac-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
</style>

<!-- Cover Section -->
<div class="profile-cover-section">
    <div class="profile-cover" style="@(string.IsNullOrEmpty(Model.CoverPhotoUrl) ? "" : $"background-image: url('{Model.CoverPhotoUrl}');")">
        <div class="cover-overlay"></div>
        <button class="btn btn-sm btn-light position-absolute top-0 end-0 m-3 rounded-pill fw-bold" data-bs-toggle="modal" data-bs-target="#coverModel">
            <i class="bi bi-camera me-1"></i> Đổi ảnh bìa
        </button>
    </div>

    <div class="profile-header-card">
        <div class="avatar-box">
             <img id="avatarPreview"
                 src="@(string.IsNullOrEmpty(Model.AvatarUrl) ? $"https://ui-avatars.com/api/?name={Model.FullName?.Replace(" ", "+") ?? "User"}&background=random&size=150" : Model.AvatarUrl)"
                 class="avatar-img"
                 alt="@Model.FullName">
            <div class="avatar-badge" data-bs-toggle="modal" data-bs-target="#avatarModal" title="Đổi ảnh">
                <i class="bi bi-camera-fill small"></i>
            </div>
        </div>
        <div class="flex-grow-1">
            <h2 class="fw-bold mb-1">@Model.FullName</h2>
            <div class="d-flex flex-wrap gap-2 text-muted mb-2">
                <span><i class="bi bi-person-badge me-1"></i>@(User.IsInRole("Landlord") ? "Chủ nhà trọ" : "Người tìm trọ")</span>
                @if (Model.IsVerified) { <span class="text-success"><i class="bi bi-patch-check-fill me-1"></i>Đã xác minh</span> }
                else { <span class="text-warning cursor-pointer" data-bs-toggle="modal" data-bs-target="#verifyEmailModal"><i class="bi bi-exclamation-circle me-1"></i>Chưa xác minh</span> }
            </div>
             <div class="d-flex flex-wrap gap-3 text-sm text-secondary">
                 <span><i class="bi bi-geo-alt me-1"></i>@(Model.District ?? "Chưa có địa chỉ")</span>
                 <span><i class="bi bi-envelope me-1"></i>@Model.Email</span>
             </div>
        </div>
        <div class="d-flex gap-2">
            <a href="@Url.Action("Edit", "Profile")" class="btn btn-primary rounded-pill px-4 fw-bold">
                <i class="bi bi-pencil-square me-2"></i>Chỉnh sửa
            </a>
            <a href="@Url.Action("ChangePassword", "Profile")" class="btn btn-outline-secondary rounded-circle" title="Cài đặt">
                <i class="bi bi-gear-fill"></i>
            </a>
        </div>
    </div>
</div>

<div class="container pb-5">
    <div class="row g-4">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3">
            <div class="nav flex-column nav-pills-custom mb-4" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                <button class="nav-link active" id="v-pills-home-tab" data-bs-toggle="pill" data-bs-target="#v-pills-home" type="button" role="tab" aria-selected="true">
                    <i class="bi bi-grid-fill"></i>Tổng quan
                </button>
                <button class="nav-link" id="v-pills-profile-tab" data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab" aria-selected="false">
                    <i class="bi bi-person-lines-fill"></i>Thông tin cá nhân
                </button>
                <button class="nav-link" id="v-pills-preferences-tab" data-bs-toggle="pill" data-bs-target="#v-pills-preferences" type="button" role="tab" aria-selected="false">
                    <i class="bi bi-sliders"></i>Nhu cầu tìm kiếm
                </button>
                <button class="nav-link" id="v-pills-activity-tab" data-bs-toggle="pill" data-bs-target="#v-pills-activity" type="button" role="tab" aria-selected="false">
                    <i class="bi bi-clock-history"></i>Lịch sử hoạt động
                </button>
            </div>

            <div class="quick-actions-card">
                <h6 class="fw-bold mb-3">Trạng thái tài khoản</h6>
                <div class="d-flex justify-content-between align-items-center mb-2 small">
                    <span class="text-muted">Email</span>
                    @if(Model.EmailConfirmed) { <i class="bi bi-check-circle-fill text-success"></i> }
                    else { <span class="badge bg-warning text-dark">Chờ xác thực</span> }
                </div>
                 <div class="d-flex justify-content-between align-items-center mb-2 small">
                    <span class="text-muted">Số điện thoại</span>
                    @if(!string.IsNullOrEmpty(Model.PhoneNumber)) { <i class="bi bi-check-circle-fill text-success"></i> }
                    else { <span class="text-muted">-</span> }
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            
            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3">
                    <a href="@Url.Action("Index", "Roommates")" class="action-btn">
                        <i class="bi bi-people-fill action-icon"></i>
                        <span class="fw-bold small">Tìm bạn ở ghép</span>
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="#" class="action-btn">
                        <i class="bi bi-heart-fill action-icon text-danger"></i>
                        <span class="fw-bold small">Đã lưu</span>
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="#" class="action-btn">
                         <i class="bi bi-chat-dots-fill action-icon text-info"></i>
                        <span class="fw-bold small">Tin nhắn</span>
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="@Url.Action("Index", "Rooms")" class="action-btn">
                        <i class="bi bi-house-door-fill action-icon text-success"></i>
                         <span class="fw-bold small">Tìm phòng</span>
                    </a>
                </div>
            </div>

            <div class="tab-content" id="v-pills-tabContent">
                
                <!-- 1. OVERVIEW TAB -->
                <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel">
                     <div class="row g-4">
                         <div class="col-md-4">
                             <div class="content-card text-center py-4">
                                 <h3 class="fw-bold text-primary mb-1">@Model.TotalListings</h3>
                                 <span class="text-muted small fw-bold text-uppercase">Bài đăng</span>
                             </div>
                         </div>
                         <div class="col-md-4">
                             <div class="content-card text-center py-4">
                                 <h3 class="fw-bold text-success mb-1">@Model.SuccessfulBookings</h3>
                                 <span class="text-muted small fw-bold text-uppercase">Giao dịch</span>
                             </div>
                         </div>
                         <div class="col-md-4">
                             <div class="content-card text-center py-4">
                                 <h3 class="fw-bold text-warning mb-1">@Model.AverageRating.ToString("0.0") <i class="bi bi-star-fill small"></i></h3>
                                 <span class="text-muted small fw-bold text-uppercase">Uy tín</span>
                             </div>
                         </div>

                         <!-- Zodiac Rich Display -->
                         <div class="col-md-12">
                             <a href="@Url.Action("Index", "Zodiac")" class="text-decoration-none">
                                <div class="zodiac-card d-flex align-items-center justify-content-between position-relative overflow-hidden">
                                    <!-- Background decoration -->
                                    <div class="position-absolute top-0 end-0 p-4 opacity-10" style="font-size: 10rem; transform: translate(30%, -30%);">
                                        <i class="bi bi-stars"></i>
                                    </div>
                                    
                                    @{
                                        Unistay_Web.Helpers.ZodiacInfo? zodiacInfo = null;
                                        try {
                                            if (!string.IsNullOrEmpty(Model.ZodiacSign)) {
                                                zodiacInfo = Unistay_Web.Helpers.ZodiacHelper.GetZodiacInfoByName(Model.ZodiacSign);
                                            } else if (Model.DateOfBirth.HasValue) {
                                                zodiacInfo = Unistay_Web.Helpers.ZodiacHelper.GetZodiacInfo(Model.DateOfBirth.Value);
                                            }
                                        } catch {}
                                    }

                                    <div class="text-white position-relative z-1">
                                        <div class="small text-uppercase opacity-75 fw-bold mb-2"><i class="bi bi-stars text-warning me-2"></i>Cung Hoàng Đạo</div>
                                        @if(zodiacInfo != null)
                                        {
                                            <h2 class="fw-bold mb-0 display-6">@zodiacInfo.VietnameseName</h2>
                                            <div class="d-flex align-items-center gap-2 mt-1 opacity-75">
                                                <span class="fw-medium">@zodiacInfo.Name</span>
                                                <span>&bull;</span>
                                                <small>@zodiacInfo.DateRange</small>
                                            </div>
                                            <!-- Traits Badge -->
                                            <div class="mt-3 d-flex flex-wrap gap-1">
                                                @foreach(var trait in (zodiacInfo.Traits ?? "").Split(',')) {
                                                    <span class="badge bg-white bg-opacity-10 backdrop-blur rounded-pill fw-normal border border-white border-opacity-25">@trait.Trim()</span>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <h3 class="fw-bold mb-0">Chưa cập nhật</h3>
                                            <p class="mb-0 opacity-75 small mt-1">Cập nhật ngày sinh để xem cung hoàng đạo của bạn</p>
                                        }
                                    </div>
                                    <div class="zodiac-icon position-relative z-1 display-1 mb-0" style="text-shadow: 0 0 20px rgba(255,255,255,0.5);">
                                        @if(zodiacInfo != null) { @Html.Raw(zodiacInfo.Icon) } else { <span class="opacity-50">✨</span> }
                                    </div>
                                </div>
                             </a>
                         </div>

                         <div class="col-md-12">
                             <div class="content-card">
                                 <div class="section-title">
                                     <span>Giới thiệu</span>
                                 </div>
                                 <p class="text-muted mb-0" style="line-height: 1.6;">
                                     @(string.IsNullOrEmpty(Model.Bio) ? "Người dùng này chưa viết gì về bản thân." : Model.Bio)
                                 </p>
                             </div>
                         </div>
                     </div>
                </div>

                <!-- 2. PERSONAL INFO TAB -->
                <div class="tab-pane fade" id="v-pills-profile" role="tabpanel">
                    <div class="content-card">
                        <div class="section-title">
                            <span>Thông tin chi tiết</span>
                            <a href="@Url.Action("Edit", "Profile")" class="btn btn-sm btn-light text-primary fw-bold rounded-pill">Chỉnh sửa</a>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Họ và tên</span>
                            <span class="info-value">@Model.FullName</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Giới tính</span>
                            <span class="info-value">@(Model.Gender == "Male" ? "Nam" : (Model.Gender == "Female" ? "Nữ" : "Khác"))</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ngày sinh</span>
                            <span class="info-value">@(Model.DateOfBirth.HasValue ? Model.DateOfBirth.Value.ToString("dd/MM/yyyy") : "Chưa cập nhật")</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Nghề nghiệp</span>
                            <span class="info-value">@(Model.Occupation ?? "Chưa cập nhật")</span>
                        </div>
                         <div class="info-row">
                            <span class="info-label">Tham gia từ</span>
                            <span class="info-value">@Model.CreatedAt.ToString("MM/yyyy")</span>
                        </div>
                    </div>
                </div>

                <!-- 3. PREFERENCES TAB -->
                <div class="tab-pane fade" id="v-pills-preferences" role="tabpanel">
                     <div class="content-card">
                        <div class="section-title">
                            <span>Nhu cầu tìm kiếm hiện tại</span>
                            <a href="@Url.Action("Edit", "Profile")" class="btn btn-sm btn-light text-primary fw-bold rounded-pill">Cập nhật</a>
                        </div>
                         <div class="row g-4">
                             <div class="col-md-6">
                                 <div class="p-3 bg-light rounded-3 border">
                                     <label class="small text-muted fw-bold text-uppercase mb-1">Khu vực ưu tiên</label>
                                     <div class="fw-bold fs-5 text-dark"><i class="bi bi-geo-alt-fill text-danger me-2"></i>@(Model.LivingArea ?? "Toàn quốc")</div>
                                 </div>
                             </div>
                             <div class="col-md-6">
                                 <div class="p-3 bg-light rounded-3 border">
                                     <label class="small text-muted fw-bold text-uppercase mb-1">Ngân sách</label>
                                     <div class="fw-bold fs-5 text-success"><i class="bi bi-cash-stack me-2"></i>@(Model.Budget.HasValue ? Model.Budget.Value.ToString("#,##0") : "Thỏa thuận") <small>VNĐ</small></div>
                                 </div>
                             </div>
                         </div>
                     </div>
                </div>

                <!-- 4. ACTIVITY TAB -->
                <div class="tab-pane fade" id="v-pills-activity" role="tabpanel">
                    <div class="content-card">
                         <div class="section-title">
                            <span>Hoạt động gần đây</span>
                             <a href="@Url.Action("ActivityHistory", "Profile")" class="btn btn-sm btn-light text-primary fw-bold rounded-pill">Xem tất cả</a>
                        </div>
                        
                        <div class="activity-timeline">
                             <p class="text-center text-muted py-3">Lịch sử hoạt động đang được cập nhật...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg px-3 py-2">
            <div class="modal-header border-0">
                 <h5 class="modal-title fw-bold">Cập nhật ảnh đại diện</h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <form id="avatarForm">
                    <input type="file" id="avatarFile" class="form-control mb-3" accept="image/*">
                    <button type="button" class="btn btn-primary rounded-pill w-100" id="uploadAvatarBtn">Lưu thay đổi</button>
                    <div id="uploadProgress" class="progress mt-3 d-none" style="height: 5px;"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div></div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="coverModel" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
         <div class="modal-content border-0 shadow-lg px-3 py-2">
            <div class="modal-header border-0">
                 <h5 class="modal-title fw-bold">Cập nhật ảnh bìa</h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                 <form id="coverForm">
                    <input type="file" id="coverFile" class="form-control mb-3" accept="image/*">
                    <button type="button" class="btn btn-primary rounded-pill w-100" id="uploadCoverBtn">Lưu thay đổi</button>
                    <div id="uploadCoverProgress" class="progress mt-3 d-none" style="height: 5px;"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div></div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="verifyEmailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg p-3">
             <div class="modal-body text-center">
                 <div class="mb-3 text-primary bg-primary-subtle d-inline-block p-3 rounded-circle"><i class="bi bi-envelope-paper fs-1"></i></div>
                 <h4 class="fw-bold">Xác thực Email</h4>
                 <p class="text-muted">Gửi mã xác thực đến <strong>@Model.Email</strong>?</p>
                 <div id="verifyMessage"></div>
                 <button class="btn btn-primary rounded-pill w-100 mb-2" id="sendVerificationBtn">Gửi mã ngay</button>
                 <button class="btn btn-light rounded-pill w-100" data-bs-dismiss="modal">Hủy</button>
             </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        async function uploadFile(fileInputId, endpoint, progressId, updateSelectors) {
            const input = document.getElementById(fileInputId);
            if (!input.files[0]) return alert('Vui lòng chọn ảnh!');
            const btn = document.querySelector(`button[onclick*="${fileInputId}"]`) || input.parentElement.querySelector('button');
            btn.disabled = true;
            document.getElementById(progressId).classList.remove('d-none');
            const formData = new FormData();
            formData.append('file', input.files[0]);
            try {
                const res = await fetch(endpoint, { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                   location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            } catch (err) {
                console.error(err);
                alert('Có lỗi xảy ra.');
            } finally {
                btn.disabled = false;
                document.getElementById(progressId).classList.add('d-none');
            }
        }
        document.getElementById('uploadAvatarBtn').onclick = () => uploadFile('avatarFile', '/api/Upload/avatar', 'uploadProgress');
        document.getElementById('uploadCoverBtn').onclick = () => uploadFile('coverFile', '/api/Upload/cover', 'uploadCoverProgress');
        document.getElementById('sendVerificationBtn').onclick = async function() {
            this.disabled = true;
            this.textContent = 'Đang gửi...';
            try {
                const res = await fetch('@Url.Action("VerifyEmail", "Profile")', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]')?.value }
                });
                const data = await res.json();
                document.getElementById('verifyMessage').innerHTML = `<div class="alert alert-${data.success ? 'success' : 'danger'}">${data.message}</div>`;
                if(data.success) setTimeout(() => bootstrap.Modal.getInstance(document.getElementById('verifyEmailModal')).hide(), 2000);
            } catch(e) {
                 document.getElementById('verifyMessage').innerHTML = `<div class="alert alert-danger">Lỗi kết nối</div>`;
            } finally {
                this.disabled = false;
                this.textContent = 'Gửi mã ngay';
            }
        };
    </script>
}