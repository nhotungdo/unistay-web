@model Unistay_Web.Models.User.UserProfile
@using Unistay_Web.Helpers
@{
    ViewData["Title"] = "Hồ sơ của tôi";
}

<!-- Custom Styles for Profile Page -->
<style>
    .profile-header-bg {
        position: relative;
        height: 380px;
        background: radial-gradient(circle at 10% 20%, rgb(80, 70, 229) 0%, rgb(15, 23, 42) 90%);
        background-size: cover;
        background-position: center;
        border-radius: 0 0 40px 40px;
        overflow: hidden;
        margin-bottom: 80px;
        transition: all 0.5s ease;
    }
    
    .cover-edit-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 20;
    }

    .profile-header-bg:hover .cover-edit-btn {
        opacity: 1;
    }

    .mesh-gradient-orb {
        position: absolute;
        width: 600px;
        height: 600px;
        background: radial-gradient(circle, rgba(124, 58, 237, 0.4) 0%, rgba(0,0,0,0) 70%);
        top: -200px;
        left: -100px;
        filter: blur(50px);
        animation: breath 10s infinite ease-in-out;
    }

    .mesh-gradient-orb-2 {
        position: absolute;
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, rgba(56, 189, 248, 0.3) 0%, rgba(0,0,0,0) 70%);
        bottom: -100px;
        right: -100px;
        filter: blur(50px);
        animation: breath 12s infinite ease-in-out reverse;
    }

    @@keyframes breath {
        0%, 100% { transform: scale(1); opacity: 0.8; }
        50% { transform: scale(1.1); opacity: 1; }
    }

    .profile-card-floating {
        position: relative;
        margin-top: -140px;
        z-index: 10;
    }

    .avatar-wrapper {
        position: relative;
        width: 160px;
        height: 160px;
        border-radius: 50%;
        padding: 6px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .avatar-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid var(--bg-surface);
    }

    /* Bento Grid System */
    .bento-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-auto-rows: minmax(160px, auto);
        gap: 1.5rem;
    }

    .bento-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-glass);
        border-radius: 24px;
        padding: 1.5rem;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease, border-color 0.3s ease;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .bento-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px -5px rgba(0,0,0,0.15);
        border-color: rgba(var(--primary-hue), var(--primary-sat), var(--primary-light), 0.3);
        z-index: 2;
    }

    .span-col-1 { grid-column: span 1; }
    .span-col-2 { grid-column: span 2; }
    .span-col-3 { grid-column: span 3; }
    .span-col-4 { grid-column: span 4; }
    .span-row-2 { grid-row: span 2; }

    @@media (max-width: 992px) {
        .bento-grid { grid-template-columns: repeat(2, 1fr); }
        .span-col-1, .span-col-2, .span-col-3, .span-col-4 { grid-column: span 2 !important; }
        
        .profile-header-bg { height: 320px; border-radius: 0 0 30px 30px; margin-bottom: 300px; /* Compensate for stacked layout */ }
        .profile-card-floating { margin-top: -180px; text-align: center; }
        .d-flex.profile-actions { justify-content: center !important; }
        .hero-info { text-align: center; margin-top: 1rem; }
    }
    
    @@media (max-width: 768px) {
        .profile-header-bg { margin-bottom: 60px; } /* Reset */
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        letter-spacing: -1px;
        line-height: 1.1;
    }

    .icon-box {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }

    .bg-gradient-primary-soft {
        background: linear-gradient(135deg, rgba(var(--primary-hue), var(--primary-sat), 60%, 0.1), rgba(var(--primary-hue), var(--primary-sat), 60%, 0.05));
    }
</style>

<!-- Hero Section -->
<div class="profile-header-bg" style="@(string.IsNullOrEmpty(Model.CoverPhotoUrl) ? "" : $"background-image: url('{Model.CoverPhotoUrl}');")">
    @if(string.IsNullOrEmpty(Model.CoverPhotoUrl)) {
        <div class="mesh-gradient-orb"></div>
        <div class="mesh-gradient-orb-2"></div>
    }
    
    <button class="btn btn-light btn-sm rounded-pill shadow-sm cover-edit-btn" 
            data-bs-toggle="modal" 
            data-bs-target="#coverModel">
        <i class="bi bi-camera-fill me-2"></i> Đổi ảnh bìa
    </button>

    <div class="container h-100 position-relative z-1">
        <div class="d-flex h-100 align-items-center justify-content-center text-center">
            <!-- Optional content intended for the very top background -->
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="container pb-5" style="margin-top: -240px; position: relative; z-index: 10;">
    <!-- Profile ID Card -->
    <div class="glass-panel p-4 mb-5 animate-slide-up">
        <div class="row align-items-end">
            <div class="col-lg-auto text-center text-lg-start">
                 <div class="avatar-wrapper mx-auto mx-lg-0">
                    <img id="avatarPreview"
                         src="@(string.IsNullOrEmpty(Model.AvatarUrl) ? $"https://ui-avatars.com/api/?name={Model.FullName?.Replace(" ", "+") ?? "User"}&background=random&size=160" : Model.AvatarUrl)"
                         class="avatar-image" 
                         alt="@Model.FullName">
                    <button class="btn btn-primary btn-sm rounded-circle position-absolute bottom-0 end-0 shadow-lg d-flex align-items-center justify-content-center" 
                            style="width: 40px; height: 40px; right: 8px !important; bottom: 8px !important;"
                            data-bs-toggle="modal"
                            data-bs-target="#avatarModal"
                            title="Đổi ảnh đại diện">
                        <i class="bi bi-camera-fill"></i>
                    </button>
                </div>
            </div>
            
            <div class="col-lg pt-3 pt-lg-0 hero-info">
                 <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-2 mb-2">
                    <h1 class="display-6 fw-bold mb-0 text-white shadow-sm" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">@Model.FullName</h1>
                    @if (Model.IsVerified)
                    {
                        <span class="badge bg-success-subtle text-success border border-success border-opacity-25 rounded-pill" title="Đã xác minh danh tính">
                            <i class="bi bi-patch-check-fill"></i>
                        </span>
                    }
                </div>
                <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start gap-3 text-white-50 mb-3">
                    <span><i class="bi bi-envelope me-2"></i>@Model.Email</span>
                    @if(!string.IsNullOrEmpty(Model.PhoneNumber)) {
                        <span><i class="bi bi-telephone me-2"></i>@Model.PhoneNumber</span>
                    }
                    <span class="badge bg-white bg-opacity-25 text-white border border-white border-opacity-25 backdrop-blur">
                        @(User.IsInRole("Landlord") ? "Chủ trọ" : "Người tìm trọ")
                    </span>
                </div>
            </div>

            <div class="col-lg-auto pb-lg-2 mt-4 mt-lg-0">
                <div class="d-flex profile-actions gap-3 justify-content-center">
                    <a href="@Url.Action("Edit", "Profile")" class="btn btn-primary px-4 py-2 rounded-pill shadow-lg hover-scale">
                        <i class="bi bi-pencil-square me-2"></i>Chỉnh sửa hồ sơ
                    </a>
                    <a href="@Url.Action("ChangePassword", "Profile")" class="btn btn-light bg-surface text-body px-4 py-2 rounded-pill shadow-sm border border-glass hover-scale">
                        <i class="bi bi-gear-fill me-2"></i>Cài đặt
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bento Grid -->
    <div class="bento-grid animate-fade-in" style="animation-delay: 0.1s;">
        
        <!-- 1. Key Metrics (Span 2) -->
        <div class="bento-card span-col-2 bg-gradient-primary-soft justify-content-between flex-row align-items-center px-5 py-4">
             <div class="text-center">
                <div class="stat-number text-gradient">@Model.TotalListings</div>
                <div class="small fw-bold text-muted text-uppercase mt-1">Bài đăng</div>
             </div>
             <div class="vr bg-secondary opacity-25" style="height: 60%;"></div>
             <div class="text-center">
                <div class="stat-number text-success">@Model.SuccessfulBookings</div>
                 <div class="small fw-bold text-muted text-uppercase mt-1">Giao dịch</div>
             </div>
             <div class="vr bg-secondary opacity-25" style="height: 60%;"></div>
             <div class="text-center">
                <div class="stat-number text-warning">@Model.AverageRating.ToString("0.0")</div>
                 <div class="small fw-bold text-muted text-uppercase mt-1">Uy tín</div>
             </div>
        </div>

        <!-- 2. Security Status (Span 1) -->
        <div class="bento-card span-col-1">
            <div class="icon-box bg-success-subtle text-success mb-3">
                <i class="bi bi-shield-check"></i>
            </div>
            <h5 class="fw-bold mb-3">Bảo mật</h5>
            <div class="mt-auto d-flex flex-column gap-2">
                <div class="d-flex align-items-center justify-content-between small">
                    <span class="text-muted"><i class="bi bi-envelope me-2"></i>Email</span>
                    @if(Model.EmailConfirmed) { <i class="bi bi-check-circle-fill text-success"></i> }
                    else { <a href="#" data-bs-toggle="modal" data-bs-target="#verifyEmailModal" class="text-warning text-decoration-underline">Xác thực</a> }
                </div>
                 <div class="d-flex align-items-center justify-content-between small">
                    <span class="text-muted"><i class="bi bi-person-badge me-2"></i>CCCD</span>
                     @if(Model.IsIdVerified) { <i class="bi bi-check-circle-fill text-success"></i> }
                     else { <span class="text-muted">-</span> }
                </div>
            </div>
        </div>

        <!-- 3. Membership Info (Span 1) -->
        <div class="bento-card span-col-1 align-items-center justify-content-center text-center">
            <div class="position-absolute top-0 end-0 p-3 opacity-25">
                <i class="bi bi-stars fs-1 text-warning"></i>
            </div>
             <div class="icon-box bg-primary-subtle text-primary mb-3">
                <i class="bi bi-calendar4-week"></i>
            </div>
            <h6 class="text-muted mb-1 text-uppercase small fw-bold">Thành viên từ</h6>
            <h3 class="fw-bold mb-0">@Model.CreatedAt.ToString("MM/yyyy")</h3>
        </div>

        <!-- 4. Bio & Lifestyle (Span 2, Row 2) - Large Card -->
        <div class="bento-card span-col-2 span-row-2">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">Giới thiệu</h4>
                <div class="badge bg-secondary-subtle text-secondary rounded-pill px-3">Bio</div>
            </div>
            
            <div class="flex-grow-1">
                @if (!string.IsNullOrEmpty(Model.Bio))
                {
                    <p class="text-muted fs-5 leading-relaxed">@Model.Bio</p>
                }
                else
                {
                    <div class="text-center py-5 text-muted bg-surface-secondary rounded-4 border-2 border-dashed border-secondary border-opacity-25">
                        <i class="bi bi-text-paragraph fs-1 mb-3 d-block opacity-50"></i>
                        <p class="mb-2">Bạn chưa viết gì về bản thân.</p>
                        <a href="@Url.Action("Edit", "Profile")" class="fw-bold text-primary">Viết ngay</a>
                    </div>
                }
            </div>

            <div class="mt-4 pt-4 border-top border-glass">
                <h6 class="fw-bold fs-6 mb-3 d-flex align-items-center gap-2">
                    <i class="bi bi-person-gear text-primary"></i> Thông tin thêm
                </h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center gap-3">
                            <div class="bg-surface-secondary border-glass rounded p-2 text-primary">
                                <i class="bi bi-briefcase"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Nghề nghiệp</small>
                                <span class="fw-medium">@(Model.Occupation ?? "Chưa cập nhật")</span>
                            </div>
                        </div>
                    </div>
                     <div class="col-md-6">
                        <div class="d-flex align-items-center gap-3">
                            <div class="bg-surface-secondary border-glass rounded p-2 text-info">
                                <i class="bi bi-heart-pulse"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Lối sống</small>
                                <span class="fw-medium">@(string.IsNullOrEmpty(Model.Lifestyle) ? "Chưa cập nhật" : "Đã cập nhật")</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. Rental Preferences (Span 2) -->
         <div class="bento-card span-col-2 bg-surface text-white" style="background: linear-gradient(145deg, var(--bg-surface), rgba(var(--primary-hue), var(--primary-sat), 20%, 0.3));">
             <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h5 class="fw-bold mb-1">Nhu cầu & Ngân sách</h5>
                    <small class="text-muted">Thông tin tìm kiếm hiện tại của bạn</small>
                </div>
                <div class="icon-box bg-white bg-opacity-10 text-white rounded-circle">
                    <i class="bi bi-search"></i>
                </div>
             </div>
             
             <div class="row g-3 mt-auto">
                 <div class="col-6">
                     <div class="p-3 rounded-4 bg-black bg-opacity-20 border border-white border-opacity-10">
                         <label class="small text-white-50 mb-1">Khu vực</label>
                         <div class="fw-bold text-truncate">
                             <i class="bi bi-geo-alt-fill text-danger me-1"></i>
                             @(Model.LivingArea ?? Model.District ?? "Chưa rõ")
                         </div>
                     </div>
                 </div>
                 <div class="col-6">
                     <div class="p-3 rounded-4 bg-black bg-opacity-20 border border-white border-opacity-10">
                         <label class="small text-white-50 mb-1">Ngân sách</label>
                         <div class="fw-bold text-success">
                             @(Model.Budget.HasValue ? Model.Budget.Value.ToString("#,##0") + " đ" : "Thỏa thuận")
                         </div>
                     </div>
                 </div>
             </div>
         </div>
         
         <!-- 5a. Zodiac Sign (Span 2) -->
         <div class="bento-card span-col-2 text-white overflow-hidden" style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);">
             @{
                 var zodiacName = Model.ZodiacSign;
                 var zodiacInfo = !string.IsNullOrEmpty(zodiacName) 
                     ? ZodiacHelper.GetZodiacInfoByName(zodiacName) 
                     : (Model.DateOfBirth.HasValue ? ZodiacHelper.GetZodiacInfo(Model.DateOfBirth.Value) : null);
             }
             
             <!-- Decor -->
             <div class="position-absolute top-0 end-0 p-3 opacity-10">
                 <i class="bi bi-stars display-1"></i>
             </div>
             <div class="position-absolute bottom-0 start-0 p-4 opacity-10">
                 <i class="bi bi-moon-stars-fill display-4"></i>
             </div>

             <div class="d-flex justify-content-between align-items-center mb-3 position-relative z-1">
                 <h5 class="fw-bold mb-0 text-white"><i class="bi bi-star-fill text-warning me-2"></i>Cung Hoàng Đạo</h5>
                 @if (zodiacInfo != null)
                 {
                     <span class="badge bg-white bg-opacity-20 text-white border border-white border-opacity-25 rounded-pill px-3">
                         @zodiacInfo.DateRange
                     </span>
                 }
             </div>

             <div class="d-flex flex-column justify-content-center align-items-center flex-grow-1 text-center position-relative z-1 py-3">
                 @if (zodiacInfo != null)
                 {
                     <div class="display-3 mb-2 animate-breath" style="animation: breath 4s infinite ease-in-out;">@zodiacInfo.Icon</div>
                     <h2 class="fw-bold mb-1 text-white text-uppercase" style="letter-spacing: 2px;">@zodiacInfo.VietnameseName</h2>
                     <small class="text-white-50 text-uppercase tracking-widest mb-3">@zodiacInfo.Name</small>
                     
                     <div class="d-flex gap-2 flex-wrap justify-content-center mt-2">
                         @foreach (var trait in zodiacInfo.Traits.Split(','))
                         {
                             <span class="badge bg-white bg-opacity-10 border border-white border-opacity-25 rounded-pill fw-normal px-3 py-2">
                                 @trait.Trim()
                             </span>
                         }
                     </div>
                 }
                 else
                 {
                     <div class="text-white-50">
                         <i class="bi bi-calendar-event fs-1 mb-3 d-block opacity-50"></i>
                         <p class="mb-2">Cập nhật ngày sinh để xem.</p>
                         <a href="@Url.Action("Edit", "Profile")" class="btn btn-sm btn-outline-light rounded-pill px-4">Cập nhật</a>
                     </div>
                 }
             </div>
         </div>

        <!-- 6. Activity & Logs (Span 2) -->
        <div class="bento-card span-col-2">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Hoạt động</h5>
                <a href="@Url.Action("ActivityHistory", "Profile")" class="btn btn-sm btn-light rounded-pill px-3">
                    Chi tiết <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
            
            <div class="d-flex flex-column gap-3 mt-2">
                 @if (ViewBag.ActivityHistory != null)
                 {
                     var history = ViewBag.ActivityHistory as IEnumerable<Unistay_Web.Models.User.ActivityHistory>;
                     if (history != null && history.Any())
                     {
                         foreach (var activity in history.Take(2))
                         {
                             <div class="d-flex align-items-start gap-3 p-2 rounded-3 hover-bg-light transition-fast">
                                 <div class="rounded-circle bg-primary-subtle text-primary p-2 d-flex align-items-center justify-content-center flex-shrink-0" style="width: 36px; height: 36px;">
                                     <i class="bi bi-clock-history small"></i>
                                 </div>
                                 <div class="overflow-hidden">
                                     <p class="mb-0 small fw-medium text-truncate">@activity.Description</p>
                                     <small class="text-muted extra-small">@activity.ActivityDate.ToString("dd/MM/yyyy HH:mm")</small>
                                 </div>
                             </div>
                         }
                     }
                     else
                     {
                         <div class="text-center text-muted small py-3">Chưa có hoạt động.</div>
                     }
                 }
            </div>
        </div>

    </div>
</div>

<!-- =========================
     MODALS (Preserved Logic)
     ========================= -->

<!-- Avatar Upload Modal -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel border-0 shadow-2xl">
            <div class="modal-header border-light">
                <h5 class="modal-title fw-bold">Đổi ảnh đại diện</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="avatarForm" enctype="multipart/form-data">
                    <div class="upload-zone p-5 border-2 border-dashed border-primary-subtle rounded-4 text-center cursor-pointer hover-bg-light transition-base position-relative mb-3">
                        <input class="position-absolute w-100 h-100 top-0 start-0 opacity-0 cursor-pointer" type="file" id="avatarFile" name="avatarFile" accept=".jpg,.jpeg,.png,.gif" required onchange="previewFile(this, 'filePreview', 'uploadPlaceholder', 'filePreviewContainer')">
                        <div id="uploadPlaceholder">
                             <i class="bi bi-cloud-arrow-up text-primary display-4 mb-3 d-block"></i>
                             <p class="fw-bold mb-1">Kéo thả hoặc nhấp để tải lên</p>
                             <small class="text-muted">JPG, PNG, GIF (Max 5MB)</small>
                        </div>
                         <div id="filePreviewContainer" class="d-none">
                              <img id="filePreview" src="" class="rounded-circle shadow-lg mb-3 border border-4 border-white" style="width: 120px; height: 120px; object-fit: cover;">
                              <p class="small fw-bold text-dark mb-0">Đã chọn ảnh mới</p>
                         </div>
                    </div>
                   
                    <div id="uploadProgress" class="progress" style="height: 8px; display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-gradient-primary" role="progressbar" style="width: 0%"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-light">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" id="uploadAvatarBtn">Cập nhật ảnh</button>
            </div>
        </div>
    </div>
</div>

<!-- Cover Upload Modal -->
<div class="modal fade" id="coverModel" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content glass-panel border-0 shadow-2xl">
            <div class="modal-header border-light">
                <h5 class="modal-title fw-bold">Đổi ảnh bìa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="coverForm" enctype="multipart/form-data">
                    <div class="upload-zone p-5 border-2 border-dashed border-primary-subtle rounded-4 text-center cursor-pointer hover-bg-light transition-base position-relative mb-3">
                        <input class="position-absolute w-100 h-100 top-0 start-0 opacity-0 cursor-pointer" type="file" id="coverFile" name="coverFile" accept=".jpg,.jpeg,.png,.gif" required onchange="previewFile(this, 'coverPreview', 'coverPlaceholder', 'coverPreviewContainer')">
                        <div id="coverPlaceholder">
                             <i class="bi bi-image text-primary display-4 mb-3 d-block"></i>
                             <p class="fw-bold mb-1">Kéo thả hoặc nhấp để tải lên ảnh bìa</p>
                             <small class="text-muted">JPG, PNG, GIF (Max 5MB) - Tỉ lệ 16:9</small>
                        </div>
                         <div id="coverPreviewContainer" class="d-none">
                              <img id="coverPreview" src="" class="shadow-lg mb-3 border border-4 border-white rounded-3" style="width: 100%; height: 200px; object-fit: cover;">
                              <p class="small fw-bold text-dark mb-0">Đã chọn ảnh mới</p>
                         </div>
                    </div>
                   
                    <div id="uploadCoverProgress" class="progress" style="height: 8px; display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-gradient-primary" role="progressbar" style="width: 0%"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-light">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" id="uploadCoverBtn">Cập nhật ảnh bìa</button>
            </div>
        </div>
    </div>
</div>

<!-- Verify Email Modal -->
<div class="modal fade" id="verifyEmailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel border-0 shadow-2xl">
            <div class="modal-body p-5 text-center">
                <div class="mb-4 text-primary bg-primary-subtle rounded-circle d-inline-flex p-4">
                     <i class="bi bi-envelope-paper display-6"></i>
                </div>
                <h4 class="fw-bold mb-2">Xác thực Email</h4>
                <p class="text-muted mb-4">Chúng tôi sẽ gửi liên kết xác thực đến <strong>@Model.Email</strong>.</p>
                <div id="verifyMessage"></div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary btn-lg rounded-pill" id="sendVerificationBtn">Gửi liên kết</button>
                    <button type="button" class="btn btn-link text-muted text-decoration-none" data-bs-dismiss="modal">Để sau</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function previewFile(input, previewId, placeholderId, containerId) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(previewId).src = e.target.result;
                    document.getElementById(containerId).classList.remove('d-none');
                    if(placeholderId) document.getElementById(placeholderId).classList.add('d-none');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function handleUpload(fileInputId, apiUrl, endpointName, progressId, updateSelectors) {
            const fileInput = document.getElementById(fileInputId);
            const file = fileInput.files[0];
            const btn = document.querySelector(`button[onclick*="${fileInputId}"]`) || document.getElementById('upload' + endpointName + 'Btn');

            if (!file) {
                alert('Vui lòng chọn một tệp.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file); // API expects 'file'

            try {
                if(btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';
                }
                
                const progressEl = document.getElementById(progressId);
                if(progressEl) progressEl.style.display = 'flex';
                
                // Simulate progress
                const progressBar = progressEl ? progressEl.querySelector('.progress-bar') : null;
                if(progressBar) progressBar.style.width = '60%';

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData,
                    // No CSRF token needed for API endpoint as per standard API practices, 
                    // but if it was a Razor Page Validated it would need one. 
                    // Since I added [ValidateAntiForgeryToken] on Controller usually, but the new API controller 
                    // likely relies on Cookie Auth.
                });

                if(progressBar) progressBar.style.width = '100%';
                
                // Handle non-JSON responses gracefully
                const contentType = response.headers.get("content-type");
                let result;
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    result = await response.json();
                } else {
                     throw new Error("Invalid server response format");
                }


                if (response.ok && result.success) {
                    // Update images
                    if(updateSelectors && updateSelectors.length > 0) {
                        const imgs = document.querySelectorAll(updateSelectors.join(','));
                        imgs.forEach(img => {
                            if(img.tagName === 'IMG') img.src = result.url + '?' + new Date().getTime();
                            else img.style.backgroundImage = `url('${result.url}?${new Date().getTime()}')`;
                        });
                    }

                    // Reset form
                    const modal = bootstrap.Modal.getInstance(fileInput.closest('.modal'));
                    if(modal) modal.hide();
                    
                    fileInput.value = '';
                    
                    // Toast
                    showToast(result.message || 'Cập nhật thành công!');

                } else {
                    alert('Lỗi: ' + (result.message || response.statusText));
                }
            } catch (error) {
                console.error(error);
                alert('Lỗi: ' + error.message);
            } finally {
               const progressEl = document.getElementById(progressId);
               if(progressEl) progressEl.style.display = 'none';
               
               if(btn) {
                   btn.disabled = false;
                   btn.textContent = 'Cập nhật';
               }
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
             toast.className = 'position-fixed bottom-0 end-0 p-3';
             toast.style.zIndex = '1050';
             toast.innerHTML = `
                <div class="toast show align-items-center text-white bg-success border-0 shadow-lg" role="alert">
                  <div class="d-flex">
                    <div class="toast-body">
                      <i class="bi bi-check-circle-fill me-2"></i> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                  </div>
                </div>`;
             document.body.appendChild(toast);
             setTimeout(() => toast.remove(), 4000);
        }

        // Avatar Upload
        document.getElementById('uploadAvatarBtn').addEventListener('click', function () {
            handleUpload('avatarFile', '/api/Upload/avatar', 'Avatar', 'uploadProgress', ['#avatarPreview']);
        });

        // Cover Upload
        document.getElementById('uploadCoverBtn').addEventListener('click', function () {
            handleUpload('coverFile', '/api/Upload/cover', 'Cover', 'uploadCoverProgress', ['.profile-header-bg']);
        });

        // Email Verification logic
        document.getElementById('sendVerificationBtn')?.addEventListener('click', async function () {
             try {
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang gửi...';
                
                const response = await fetch('@Url.Action("VerifyEmail", "Profile")', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]')?.value || '',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('verifyMessage').innerHTML = '<div class="alert alert-success bg-success-subtle border-0 text-success"><i class="bi bi-check-circle-fill me-2"></i>Link xác thực đã được gửi!</div>';
                    this.style.display = 'none';
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('verifyEmailModal')).hide();
                    }, 3000);
                } else {
                    document.getElementById('verifyMessage').innerHTML = '<div class="alert alert-danger bg-danger-subtle border-0 text-danger">' + result.message + '</div>';
                    this.disabled = false;
                    this.textContent = 'Thử lại';
                }
            } catch (error) {
                document.getElementById('verifyMessage').innerHTML = '<div class="alert alert-danger">Lỗi: ' + error.message + '</div>';
                this.disabled = false;
                this.textContent = 'Thử lại';
            }
        });
    </script>
}